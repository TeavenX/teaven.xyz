---
title: 验证码全局提取工具实现
date: 2021-06-14 16:21:01
tags:
    - ['Python']
    - ['杂谈']
---

## 前言
1202年，越来越多的软件/网站支持用短信验证码直接登陆，因此手机上也推出了一键填入短信验证码的功能，然而这个功能没办法很好的衍生到电脑上。
:::info
因为博主没有安卓设备，本文目前只针对macOS+iPhone进行探讨
:::
## 方案
虽然macOS上的Safari已经支持自动填入iPhone收到的短信验证码，但是作为一个软件工程表演专业的人来说，Safari太不（普）专（通）业了，况且如果不用Chrome怎么把内存用完呢（OOM警告）。
一次偶然的机会，我在找workflow的时候看到了[iMessage 2FA Workflow for Alfred](https://github.com/squatto/alfred-imessage-2fa)，看效果图还不错，于是就安装试了试
![2fm](https://teaven.oss-cn-shenzhen.aliyuncs.com/2021/teaven/cleanshot-20210614-at-1646572x.png?versionId=CAEQIxiBgMDqrIPs0BciIDA3ZTViYTMwN2UyMTQ3MjY5YTRmNmYyZjhmYzY5YjA0)
第一感觉效果确实可以，但是实际检索结果有点差强人意，通常只能查到很早之前的验证码。
<div align=center>![imsg](https://teaven.oss-cn-shenzhen.aliyuncs.com/2021/teaven/imgd94cb0f6db961.jpeg?versionId=CAEQIxiBgMD3rIPs0BciIDFkNjEzOWNjZTA1ZjQ3ZTBiYzEyM2Y2YWMwMTZhMWZm)</div>
于是就去看了看2fm的实现原理，发现macOS的短信是通过`/Users/teaven/Library/Messages/chat.db`下的SQLite DB保存的。问题一下子就简单起来了。
由于对php（2fm使用php编写）不是很熟悉，加上想在此基础上拓展一些功能，例如把email的的验证码/2FALink也整合进来，于是打算用Python重写一遍，并且将其从Alfred中剥离出来。

## 实现
大体思路是
`解析chat.db数据`
`获取验证码`
`监控更新`
`读取邮件`
`匹配2FALink/CODE`
### 解析chat.db原始数据
:::info
调试的时候发现一直没办法访问chat.db，一开始以为是用户资源库有权限限制，但是alfred是可以正常访问的。于是把chat.db复制到下载目录，可以正常访问，更加坚定了我的想法。Google了一下没有结论，才想起来macOS有一个文件访问权限，之前只给iTerm开了downloads目录的，开了全盘就好了。
:::
短信查询语句直接套用了2fa的，做了一点调整，加上4位验证码的支持，然后将datetime的输出改成timestamp方便后面做判断
### 获取验证码
因为验证码短信的模板五花八门，常规匹配4-8位数字的方法会混进一些脏数据。例如
```
【预存话费，不止十倍优惠】尊敬的杭州移动用户，现邀您参加“杭州移动消费抵扣合约”活动，您只需预存10元，每月保底38元，即可得117元消费抵扣（用于话费减免），前3个月每月返15元，后9个月每月返8元，合约期12个月。点击 https://dx.10086.cn/ 可直接办理，本短信转发无效。【中国移动 和你一起】
```
会匹配到 10086 的结果。目前的过滤办法是判断`[code|码]`是否在内容里。
获取到验证码之后调用AppleScript发送通知，效果如图
![as](https://teaven.oss-cn-shenzhen.aliyuncs.com/2021/teaven/cleanshot-20210615-at-0137072x.png?versionId=CAEQIxiBgIDxrIPs0BciIDNjYzQyN2E0YTk1YTQ0NGJhYTY4YzFkMWIzMTRlZGRl)
然后借助`pyperclip`把验证码复制到剪切板
### 监控更新
完成上述步骤后整个流程已经走通了，接下来就是如何感知更新。
最先想到的是设置一个定时任务定时去读取db，但是考虑到验证码获取的及时性，定时任务间隔需要设置很短，频繁创建连接读取会造成不必要的性能损耗。
突然想起来SQLite保存的是一个db文件，那么就可以通过文件的更新时间来判断是否更新了
### 读取邮件
读取邮件花了好多时间，主要原因是Google或者百度上的资料不多，主要是发送邮件，而且都是相互转载的。看了廖雪峰大佬的博客和源码后有点头绪了。
同时也发现网上好多博客写的监听新邮件都是有问题的，因为POP3本身就是长连接协议，完成认证后就进入了`授权状态`然后通过`RETR命令`向服务器请求传送邮件内容，而很多写的都是“认证->获取邮件->关闭连接->认证”的循环。先不说服务器是否允许频繁的认证操作，这么去实现总感觉很奇怪。

现有的邮箱基本上都默认关闭pop3的授权，尝试了qq邮箱、gmail都需要手动开启。
qq邮箱需要为pop3设置独立密码；gmail需要先开启两步验证后才能启用独立密码（参考[使用应用专用密码登录](https://support.google.com/accounts/answer/185833)）
